# 第三章 存储系统

> 本章对应课件：`计算机组成原理3.1.pdf`、`计算机组成原理3.2（2）.pdf`、`计算机组成原理3.3（4）.pdf`、`计算机组成原理3.4.pdf`、`计算机组成原理3.5.pdf`

## 一、章节概述

存储系统是计算机体系结构中至关重要的一部分。它决定了数据在系统中的存放方式、访问速度以及数据一致性。在现代计算机中，存储系统呈现金字塔式分层设计，从高速小容量到低速大容量逐级扩展。

## 二、学习目标（高亮速览）

1. <mark>理解存储系统的层次结构</mark>
   - 掌握<mark>寄存器/Cache/主存/辅存</mark>之间的性能与容量差异
   - 理解<mark>局部性原理</mark>在存储层次设计中的作用

2. <mark>掌握主存储器的组织与实现</mark>
   - 熟悉<mark>SRAM</mark>与<mark>DRAM</mark>的原理与区别
   - 理解存储器芯片的<mark>编址方式</mark>与<mark>扩展方法</mark>

3. <mark>深入理解Cache存储器</mark>
   - 掌握<mark>直接映射/全相联/组相联</mark>等映射方式
   - 理解<mark>替换算法（LRU/FIFO/随机）</mark>的实现思想
   - 分析Cache性能指标与优化方法

4. <mark>掌握虚拟存储器的基本概念</mark>
   - 理解<mark>虚拟地址→物理地址</mark>的转换过程
   - 掌握<mark>页表/TLB</mark>的作用

5. <mark>了解外部存储器的工作原理</mark>
   - 磁盘的结构与寻址方式
   - 固态硬盘、闪存的工作原理与特点

## 三、核心内容详解

### 3.1 存储器概述

#### 1. 存储层次结构

从最快到最慢：
- 寄存器（Register）
- 高速缓冲存储器（Cache）
- 主存储器（Main Memory，DRAM）
- 外部存储器（磁盘、SSD、光盘等）

**层次设计目标**：在成本可控的前提下兼顾容量与速度

**局部性原理**：
- 时间局部性：最近被访问的数据很可能再次被访问
- 空间局部性：与当前访问地址相邻的数据很可能被访问

### 3.2 主存储器

#### 1. DRAM与SRAM

| 类型 | 结构 | 速度 | 容量 | 成本 | 是否易失 |
|------|------|------|------|------|-----------|
| SRAM | 6晶体管构成触发器 | 快 | 小 | 高 | 是 |
| DRAM | 一个晶体管+一个电容 | 慢 | 大 | 低 | 是 |

- **SRAM应用**：CPU内部的Cache
- **DRAM应用**：系统主存

#### 2. 存储器芯片的组织与扩展

- **编址方式**：行列地址复用（RAS/CAS）
- **容量扩展**：位扩展、字扩展、位字混合扩展
- **存储模块**：将若干DRAM芯片组合实现更大容量

**示例**：用8片8K×1位的存储芯片组成8K×8位的存储器
- 每片提供1位，共8片组成1字节
- 片选线控制各芯片

### 3.3 高速缓冲存储器（Cache）

#### 1. Cache的作用

- 缓解CPU与主存之间的速度矛盾
- 利用局部性原理

#### 2. Cache结构

- **标签（Tag）**：标识主存中的块地址
- **Cache行（Cache Line）**：缓存的最小单位，包含标签、有效位、数据块
- **有效位（Valid）**：指示数据是否有效
- **脏位（Dirty）**：指示数据是否被修改

#### 3. 地址映射方式

1. **直接映射**：主存中的一个块只能映射到Cache中的一个固定位置
   - 优点：实现简单，速度快
   - 缺点：冲突概率高

2. **全相联映射**：主存块可映射到Cache的任意行
   - 优点：命中率高
   - 缺点：硬件复杂度高

3. **组相联映射**：主存块可映射到固定组内的任一行
   - 在直接映射与全相联之间折衷

#### 4. 替换算法

- **FIFO（先进先出）**：按进入时间替换
- **LRU（最近最少使用）**：替换最近最久未使用的数据
- **随机替换**：随机选择替换行

#### 5. 写策略

- **写直达（Write-through）**：同时写Cache与主存
- **写回（Write-back）**：先写Cache，设置脏位，需要时再写回主存

### 3.4 虚拟存储器

#### 1. 基本概念

- **虚拟地址空间**：由程序员看到的逻辑地址空间
- **物理地址空间**：实际的物理内存地址
- **页（Page）**：虚拟存储器管理的基本单位
- **页表（Page Table）**：记录虚拟页与物理页框之间的映射关系

#### 2. 地址转换

1. CPU生成虚拟地址
2. 查询页表得到物理页框号
3. 将页内偏移与页框号组合成物理地址

#### 3. 快表（TLB）

- 全称Translation Lookaside Buffer
- 存储常用页表项，提高地址转换速度
- 采用全相联或组相联结构

#### 4. 页替换算法

- **Optimal**：理论最优，未来最远使用的页被替换
- **LRU**：最近最久未使用
- **FIFO**：先进先出
- **Clock（第二次机会）**：利用访问位实现近似LRU

#### 5. 页错误

- 当访问页不在主存时发生
- 触发操作系统调入所需页面

### 3.5 外部存储器

#### 1. 磁盘存储

- **结构**：盘片、磁头、主轴、电机
- **寻址方式**：柱面号、磁头号、扇区号（CHS）
- **访问时间组成**：寻道时间、旋转延迟、数据传输时间

#### 2. RAID技术

- 通过多磁盘阵列提高可靠性与性能
- RAID0 ~ RAID6不同级别

#### 3. 固态硬盘（SSD）

- 采用闪存技术（NAND Flash）
- 优势：访问速度快、抗震、功耗低
- 控制器负责磨损均衡、坏块管理、垃圾回收

#### 4. 光盘、磁带

- 光盘（CD/DVD/BD）：适合存储海量静态数据
- 磁带：多用于数据归档与备份，顺序访问

## 四、重点与难点

### 重点
1. 存储系统的分层结构与性能特征
2. Cache的原理、映射方式、替换算法
3. 虚拟存储器的基本机制

### 难点
1. Cache地址映射和替换策略分析
2. 多级页表与TLB的协同工作
3. RAID的容错机制与性能分析

## 五、教学建议

1. **类比教学**：通过仓储物流的层次结构类比存储系统
2. **动手演示**：使用动画或软件模拟展示Cache命中/缺失过程
3. **实验辅助**：安排简单Cache模拟或虚拟内存管理实验
4. **案例分析**：选择现代CPU的Cache参数案例分析

## 六、易错点检查（对照更正）

1. 认为“命中率高=访问一定更快”（不总是）。
   - 对照：需考虑<mark>命中代价/缺失代价</mark>以及多级Cache层次。
2. 把<mark>直接映射</mark>与<mark>组相联</mark>混淆。
   - 对照：直接映射每块固定位置；组相联固定在某组但可在组内任一行。
3. 误把<mark>写回</mark>理解为“立即写主存”。
   - 对照：写回先写Cache，置<mark>脏位</mark>，替换或需要时再写主存。
4. 认为TLB只缓存数据（错误）。
   - 对照：<mark>TLB缓存页表项</mark>，是地址转换加速结构。

## 七、课后练习

1. 说明存储系统为何采用多级层次结构，并举例说明不同层次的典型访问时间
2. 给定主存地址和Cache配置，分析地址映射过程并判断是否命中
3. 分析LRU与FIFO替换算法的优缺点，结合场景给出适用建议
4. 阐述虚拟存储器中页表和快表的作用及协同工作流程
5. 比较磁盘与SSD在性能、可靠性、成本上的差异

## 八、延伸阅读与资源

- Patterson & Hennessy：《Computer Organization and Design》，章节5（Cache）与章节6（虚拟存储）
- Intel® 64 and IA-32 Architectures Optimization Reference Manual
- ACM Queue: "Flash Storage Today"（了解SSD架构）

---

> **总结**：存储系统是计算机体系结构的重要整体性模块，是理解处理器性能瓶颈与系统优化的关键。希望大家在学习本章时重视理论结合实践的理解方式。